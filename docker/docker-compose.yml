services:
  audio-transcription:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        - http_proxy=${http_proxy:-}
        - https_proxy=${https_proxy:-}
        - no_proxy=${no_proxy:-}
    container_name: audio-transcription-service
    ports:
      - "8998:8998"
    env_file:
      - ../.env  # 从项目根目录加载环境变量（必须从项目根目录运行命令）
    environment:
      # 环境配置
      - ENVIRONMENT=${ENVIRONMENT:-production}
      
      # Dify 配置
      # 注意：DIFY_BASE_URL 从 env_file (.env) 加载，不在此处设置默认值
      # 如果需要在 environment 中覆盖，可以取消注释并设置值
      # - DIFY_BASE_URL=${DIFY_BASE_URL}
      - DIFY_WORKFLOW_ID=${DIFY_WORKFLOW_ID:-}
      
      # AI 模型配置
      # API Key 从 env_file 加载，不在此处设置
      - DEEPSEEK_API_BASE=${DEEPSEEK_API_BASE:-https://api.deepseek.com}
      - DEEPSEEK_MODEL=${DEEPSEEK_MODEL:-deepseek-chat}
      
      - QWEN_API_BASE=${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      - QWEN_MODEL=${QWEN_MODEL:-qwen-turbo}
      
      - GLM_API_BASE=${GLM_API_BASE:-https://open.bigmodel.cn/api/paas/v4}
      - GLM_MODEL=${GLM_MODEL:-glm-4}
      
      # 可选配置
      - PRELOAD_MODELS=${PRELOAD_MODELS:-false}
      - CLEANUP_INTERVAL_HOURS=${CLEANUP_INTERVAL_HOURS:-6}
    volumes:
      # 持久化数据目录
      - ../uploads:/app/uploads
      - ../transcripts:/app/transcripts
      - ../audio_temp:/app/audio_temp
      - ../meeting_summaries:/app/meeting_summaries
      # 模型缓存（可选，加速启动）
      - model-cache:/root/.cache/modelscope
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8998/healthz"]
      interval: 1h  # 每小时检查一次
      timeout: 10s
      retries: 3
      start_period: 120s  # 增加启动等待时间，确保存储初始化等操作完成
    networks:
      - transcription-network

volumes:
  model-cache:
    driver: local

networks:
  transcription-network:
    driver: bridge

